<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mr Quiz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      animation: fadeIn 0.5s ease-out forwards;
    }
    /* Custom styles for radio button states */
    .correct-answer {
        background-color: #166534 !important; /* green-800 */
        border-color: #22c55e !important; /* green-500 */
    }
    .incorrect-answer {
        background-color: #991b1b !important; /* red-800 */
        border-color: #ef4444 !important; /* red-500 */
    }
    .selected-answer {
        background-color: #1d4ed8 !important; /* blue-700 */
        border-color: #3b82f6 !important; /* blue-500 */
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen flex flex-col items-center p-4 sm:p-6 lg:p-8">

  <!-- Header -->
  <header class="w-full max-w-4xl text-center mb-10 fade-in">
    <div class="bg-gradient-to-r from-purple-800 to-blue-700 p-6 sm:p-8 rounded-3xl shadow-2xl border border-gray-700 transition-transform transform hover:scale-105">
      <h1 class="text-4xl sm:text-5xl font-bold tracking-wider text-white">Mr Quiz</h1>
      <p class="text-lg sm:text-xl mt-2 text-gray-300">اختبر معلوماتك بأسلوب عصري واحترافي</p>
    </div>
  </header>

  <!-- Class and Day Selection -->
  <section id="classSelection" class="w-full max-w-md text-center bg-gray-800/50 backdrop-blur-sm p-8 rounded-2xl shadow-lg border border-gray-700 fade-in">
    <h2 class="text-2xl font-bold mb-6 text-white">اختر الصف الدراسي واليوم</h2>

    <!-- Class Dropdown -->
    <div class="mb-6">
      <label for="classSelect" class="sr-only">اختر الصف</label>
      <select id="classSelect" class="w-full bg-gray-700 text-white p-3 rounded-lg border-2 border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition appearance-none text-center">
        <option value="">-- اختر الصف --</option>
        <option value="g1">أولى إعدادي</option>
        <option value="g2">تانية إعدادي</option>
        <option value="g3">تالتة إعدادي</option>
        <option value="s1">أولى ثانوي</option>
        <option value="s2">تانية ثانوي</option>
        <option value="s3">تالتة ثانوي</option>
      </select>
    </div>

    <!-- Day Dropdown -->
    <div class="mb-8">
      <label for="daySelect" class="sr-only">اختر المجموعه</label>
      <select id="daySelect" class="w-full bg-gray-700 text-white p-3 rounded-lg border-2 border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition appearance-none text-center">
        <option value="">-- اختر المجموعه --</option>
        <option value="السبت">السبت</option>
        <option value="الأحد">الأحد</option>
        <option value="الإثنين">الإثنين</option>
        <option value="الثلاثاء">الثلاثاء</option>
        <option value="الأربعاء">الأربعاء</option>
        <option value="الخميس">الخميس</option>
        <option value="الجمعة">الجمعة</option>
      </select>
    </div>

    <button id="startBtn" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transform transition-transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-blue-500">
      ابدأ الاختبار
    </button>
  </section>

  <!-- Quiz Section -->
  <section id="quizSection" class="hidden w-full max-w-4xl mt-10">
    <div class="bg-gray-800/50 backdrop-blur-sm p-6 rounded-2xl shadow-lg border border-gray-700 mb-6 fade-in">
      <h3 class="text-xl font-bold mb-4 text-white">بيانات الطالب</h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <input id="studentName" placeholder="الاسم بالكامل" class="w-full bg-gray-700 text-white p-3 rounded-lg border-2 border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
        <input id="studentPhone" placeholder="رقم الهاتف" class="w-full bg-gray-700 text-white p-3 rounded-lg border-2 border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
      </div>
    </div>
    <form id="quizForm" class="space-y-6"></form>
    <button id="submitBtn" class="w-full bg-gradient-to-r from-green-600 to-teal-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transform transition-transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-green-500 mt-8">
      إرسال الإجابات
    </button>
    <div id="result" class="mt-8 text-xl font-bold"></div>
  </section>

  <!-- WhatsApp Floating Button -->
  <a href="https://wa.me/201094724932" target="_blank" class="fixed bottom-6 right-6 bg-green-500 hover:bg-green-600 text-white p-4 rounded-full shadow-2xl transition-transform transform hover:scale-110 z-50 flex items-center justify-center">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24" fill="currentColor">
        <path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.487 5.235 3.487 8.413.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 6.213 0 11.28-5.068 11.28-11.28 0-6.213-5.068-11.28-11.28-11.28-6.213 0-11.28 5.068-11.28 11.28 0 2.168.609 4.142 1.735 5.897l.215.324-1.123 4.096 4.195-1.1.305.18c1.495.889 3.163 1.36 5.022 1.361zm7.53-6.162c-.333-.167-.74-1.12-1.088-1.328-.347-.207-.523-.333-.74-.333-.217 0-.435.083-.652.333-.217.25-.833 1.042-1.02 1.25-.188.208-.375.25-.693.083-.317-.167-1.333-.479-2.54-1.562-1.207-1.083-2.02-2.417-2.25-2.833-.23-.417-.042-.646.125-.833.15-.167.333-.417.5-.583.167-.167.25-.333.375-.542.125-.208.063-.375-.02-.542-.083-.166-.74-1.77-.917-2.125-.177-.354-.354-.302-.52-.302-.167 0-.354-.02-.53-.02s-.46.083-.7.333c-.24.25-.918.917-1.165 1.542-.248.625-.418 1.292-.418 1.917s.417 2.125.46 2.292c.04.166.916 1.542 2.25 2.833 1.333 1.291 2.375 1.666 2.79 1.833.418.167.792.146 1.083.083.292-.063.917-.542 1.042-.75.125-.208.25-.375.333-.5.083-.125.146-.208.063-.333-.083-.125-.208-.208-.333-.25z"/>
    </svg>
  </a>

  <!-- Footer -->
  <footer class="w-full text-center mt-12 mb-6 fade-in" style="animation-delay: 0.5s;">
    <a href="https://wa.me/201094724932" target="_blank" class="inline-block bg-gray-800/50 backdrop-blur-sm text-white py-3 px-6 rounded-full shadow-lg hover:bg-gray-700/70 transition-colors cursor-pointer border border-gray-700">
      <p class="font-bold text-md">صُمم بواسطة Boda</p>
      <p class="text-sm text-gray-400 mt-1">انقر للتواصل</p>
    </a>
  </footer>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbwUHe1af_HzaX8jlzrDZ_B_FdORkbx3uSxatjESVq8_tlzXGd9thALYdhFZ_IZG6Rtx/exec";

    let questions = [];
    let selectedClass = "";

    const classNames = {
      g1: "أولى إعدادي",
      g2: "تانية إعدادي",
      g3: "تالتة إعدادي",
      s1: "أولى ثانوي",
      s2: "تانية ثانوي",
      s3: "تالتة ثانوي"
    };

    // Load Questions
    document.getElementById("startBtn").addEventListener("click", async () => {
      selectedClass = document.getElementById("classSelect").value;
      const selectedDay = document.getElementById("daySelect").value;

      if (!selectedClass) return alert("من فضلك اختر الصف الدراسي");
      if (!selectedDay) return alert("من فضلك اختر اليوم");

      const btn = document.getElementById("startBtn");
      btn.disabled = true;
      btn.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>`;

      try {
        const res = await fetch(scriptURL, {
          method: "POST",
          body: JSON.stringify({
            type: "getQuestions",
            classSheet: `questions_${selectedClass}`
          })
        });

        questions = await res.json();

        if (!Array.isArray(questions) || questions.length === 0) {
          alert("لم يتم العثور على أسئلة لهذا الصف.");
          btn.disabled = false;
          btn.innerText = "ابدأ الاختبار";
          return;
        }

        showQuestions();
        document.getElementById("classSelection").classList.add("hidden");
        document.getElementById("quizSection").classList.remove("hidden");
      } catch (err) {
        alert("حدث خطأ أثناء جلب الأسئلة. تأكد من الاتصال بالإنترنت.");
        btn.disabled = false;
        btn.innerText = "ابدأ الاختبار";
      }
    });

    // Show Questions
    function showQuestions() {
      const form = document.getElementById("quizForm");
      form.innerHTML = "";
      questions.forEach((q, index) => {
        let card = document.createElement('div');
        card.className = "card bg-gray-800/50 backdrop-blur-sm p-5 rounded-xl shadow-lg border border-gray-700 transition-all duration-300 transform hover:border-blue-500";
        card.style.animation = `fadeIn 0.5s ease-out ${index * 0.1}s forwards`;
        card.style.opacity = 0;
        
        let questionText = document.createElement('p');
        questionText.className = "font-bold mb-4 text-lg text-gray-100";
        questionText.innerText = `${index + 1}. ${q.question}`;
        card.appendChild(questionText);

        let choicesContainer = document.createElement('div');
        choicesContainer.className = "space-y-3";
        
        q.choices.forEach(c => {
          let label = document.createElement('label');
          label.className = "block cursor-pointer p-3 rounded-lg bg-gray-700 hover:bg-gray-600/70 transition-colors border-2 border-transparent";
          
          let radio = document.createElement('input');
          radio.type = "radio";
          radio.name = q.id;
          radio.value = c;
          radio.className = "hidden";

          radio.addEventListener('change', () => {
            // Remove selection style from siblings
            document.querySelectorAll(`input[name="${q.id}"]`).forEach(r => {
                r.parentElement.classList.remove('selected-answer');
            });
            // Add selection style to current
            if(radio.checked) {
                label.classList.add('selected-answer');
            }
          });
          
          label.appendChild(radio);
          label.append(` ${c}`);
          choicesContainer.appendChild(label);
        });

        card.appendChild(choicesContainer);
        form.appendChild(card);
      });
    }

    // On Submit
    document.getElementById("submitBtn").addEventListener("click", async (e) => {
      e.preventDefault();

      const name = document.getElementById("studentName").value.trim();
      const phone = document.getElementById("studentPhone").value.trim();
      const day = document.getElementById("daySelect").value;

      if (!name || !phone) return alert("من فضلك اكتب الاسم ورقم التليفون");
      if (!day) return alert("من فضلك اختر اليوم قبل بدء الاختبار");

      let score = 0, wrong = [], total = questions.length;
      const submitBtn = document.getElementById("submitBtn");
      submitBtn.disabled = true;
      submitBtn.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>`;

      questions.forEach(q => {
        const selectedRadio = document.querySelector(`input[name="${q.id}"]:checked`);
        const card = selectedRadio ? selectedRadio.closest(".card") : document.querySelector(`input[name="${q.id}"]`).closest(".card");
        
        document.querySelectorAll(`input[name="${q.id}"]`).forEach(radio => {
          const label = radio.parentElement;
          label.classList.remove('selected-answer'); // Clear selection style
          
          if (radio.value === q.correct) {
            label.classList.add("correct-answer");
          }
          
          if (selectedRadio && radio === selectedRadio && selectedRadio.value !== q.correct) {
            label.classList.add("incorrect-answer");
          }
        });

        if (selectedRadio && selectedRadio.value === q.correct) {
          score++;
        } else {
          wrong.push(q.id);
          if (q.explanation && !card.querySelector(".explanation")) {
            const exp = document.createElement("div");
            exp.className = "explanation mt-4 p-3 bg-gray-900/70 rounded-lg border border-yellow-500/50 text-yellow-300";
            exp.innerHTML = `<b>الشرح:</b> ${q.explanation}`;
            card.appendChild(exp);
          }
        }
      });

      document.getElementById("result").innerHTML = `
        <div class="bg-gray-800/50 backdrop-blur-sm p-6 rounded-2xl mt-8 text-center shadow-lg border border-gray-700 fade-in">
          <p class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-green-400 to-blue-400">نتيجتك: ${score} / ${total}</p>
        </div>
      `;

      try {
        await fetch(scriptURL, {
          method: "POST",
          body: JSON.stringify({
            type: "saveResult",
            className: classNames[selectedClass],
            day,
            name, phone, score, total, wrong
          })
        });
        alert("✅ تم حفظ النتيجة بنجاح!");
      } catch (err) {
        alert("❌ حدث خطأ أثناء حفظ النتيجة. حاول مرة أخرى.");
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerText = "إرسال الإجابات";
      }
    });
  </script>
</body>
</html>
